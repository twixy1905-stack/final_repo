steps:
# 1) Build Docker image with :latest tag
  - name: gcr.io/cloud-builders/docker
    id: "build-image"
    args:
      - build
      - -f
      - app/Dockerfile
      - -t
      - us-central1-docker.pkg.dev/${_PROJECT_ID}/my-repo/myapp:latest
      - app

  # 2) Push image to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    id: "push-image"
    args:
      - push
      - "us-central1-docker.pkg.dev/${_PROJECT_ID}/my-repo/myapp:latest"

  - name: gcr.io/cloud-builders/kubectl
    id: rollout-restart
    env:
      - CLOUDSDK_CORE_PROJECT=${_PROJECT_ID}
      - CLOUDSDK_COMPUTE_REGION=${_REGION}
    args:
      - rollout
      - restart
      - deployment/myapp
      - --namespace=default
          
options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _PROJECT_ID: "devops-gke-12345"
  _REGION: "us-east1"
  _CLUSTER_NAME: "devops-gke-cluster"
